# Macula Arcade - Development Dockerfile
#
# This builds from local source for active development.
# Changes to code are reflected in fresh builds.
#
# Usage:
#   docker build -f Dockerfile.dev -t macula-arcade:dev .
#   docker compose -f docker-compose.dev.yml up --build

# ==============================================================================
# Build Stage
# ==============================================================================
FROM hexpm/elixir:1.17.3-erlang-27.1.2-ubuntu-jammy-20240808 AS builder

# Install build dependencies including Node.js for Phoenix assets
RUN apt-get update -y && \
    apt-get install -y build-essential git curl cmake && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean && rm -f /var/lib/apt/lists/*_*

# Install hex + rebar
RUN mix local.hex --force && \
    mix local.rebar --force

# Set working directory
WORKDIR /app

# Copy the entire application source
COPY system/ ./

# Clean any existing build artifacts and lock file to ensure fresh dependency resolution
RUN rm -rf _build deps mix.lock

# Get dependencies (macula will be fetched from hex.pm)
# mix.lock will be generated fresh from mix.exs
ENV MIX_ENV=prod
RUN mix deps.get --only prod

# Compile dependencies
RUN mix deps.compile

# Compile the application
RUN mix compile

# Build the release (Phoenix 1.7+ uses esbuild, no npm needed)
RUN mix assets.deploy
RUN mix release

# ==============================================================================
# Runtime Stage
# ==============================================================================
FROM ubuntu:jammy-20240808

# Install runtime dependencies
RUN apt-get update -y && \
    apt-get install -y libstdc++6 openssl libncurses5 locales curl ca-certificates && \
    apt-get clean && rm -f /var/lib/apt/lists/*_*

# Set locale
RUN sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && locale-gen
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

# Create app user
RUN useradd --create-home app
WORKDIR /home/app

# Copy release from builder
COPY --from=builder --chown=app:app /app/_build/prod/rel/macula_arcade ./

# TLS certificates will be auto-generated by Macula at runtime if not provided
RUN mkdir -p /opt/macula/certs && chown app:app /opt/macula/certs

# Switch to app user
USER app

# Expose ports
EXPOSE 4000

# Set environment
ENV MIX_ENV=prod
ENV PHX_SERVER=true

# Add build timestamp label
ARG BUILD_DATE
ARG VCS_REF
LABEL build_date=$BUILD_DATE
LABEL vcs_ref=$VCS_REF
LABEL version="dev"

# Start the release
CMD ["bin/macula_arcade", "start"]
