version: '3.8'

services:
  # Bootstrap node - first node in the mesh (v0.8.5 always-on architecture)
  arcade-gateway:
    build:
      context: .
      dockerfile: Dockerfile
      additional_contexts:
        macula: ../macula
    container_name: arcade-gateway
    hostname: arcade-gateway
    environment:
      # Macula v0.8.5 - All nodes have all capabilities (always-on)
      MACULA_QUIC_PORT: "4433"
      MACULA_REALM: "macula.arcade"
      HEALTH_PORT: "8080"
      # No MACULA_BOOTSTRAP_URL - this IS the bootstrap node

      # Phoenix config
      PORT: "4000"
      PHX_HOST: "arcade-gateway"
      SECRET_KEY_BASE: "WMw7VW0JQKZKbLLq6Y1hPrHvCvnqZvvnWMw7VW0JQKZKbLLq6Y1hPrHvCvnqZvvn"

      # TLS auto-generated in v0.8.5 (optional override)
      MACULA_CERT_PATH: "/opt/macula/certs/cert.pem"
      MACULA_KEY_PATH: "/opt/macula/certs/key.pem"

      # Database (in-memory for testing)
      DATABASE_PATH: ":memory:"

      # Logging
      LOG_LEVEL: "info"
    ports:
      - "4000:4000"   # Phoenix HTTP
      - "4433:4433/udp"   # Macula QUIC (UDP)
      - "8080:8080"   # Macula Health
    networks:
      arcade-mesh:
        ipv4_address: 172.25.0.10
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s
    volumes:
      - gateway-certs:/opt/macula/certs

  # Peer node 1 (v0.8.5 - all nodes have all capabilities)
  arcade-peer1:
    build:
      context: .
      dockerfile: Dockerfile
      additional_contexts:
        macula: ../macula
    container_name: arcade-peer1
    hostname: arcade-peer1
    environment:
      # Macula v0.8.5 - All nodes have all capabilities
      MACULA_QUIC_PORT: "4433"
      MACULA_REALM: "macula.arcade"
      HEALTH_PORT: "8080"
      # Connect to bootstrap node
      MACULA_BOOTSTRAP_URL: "https://arcade-gateway:4433"

      # Phoenix config
      PORT: "4000"
      PHX_HOST: "arcade-peer1"
      SECRET_KEY_BASE: "XNx8WX1KRLaLcMMr7Z2iQsIwDworaAwowXNx8WX1KRLaLcMMr7Z2iQsIwDworaAwo"

      # TLS auto-generated in v0.8.5
      MACULA_CERT_PATH: "/opt/macula/certs/cert.pem"
      MACULA_KEY_PATH: "/opt/macula/certs/key.pem"

      # Database (in-memory)
      DATABASE_PATH: ":memory:"

      # Logging
      LOG_LEVEL: "info"
    ports:
      - "4001:4000"
      - "4434:4433/udp"
      - "8081:8080"
    networks:
      arcade-mesh:
        ipv4_address: 172.25.0.11
    depends_on:
      arcade-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s

  # Peer node 2 (v0.8.5 - all nodes have all capabilities)
  arcade-peer2:
    build:
      context: .
      dockerfile: Dockerfile
      additional_contexts:
        macula: ../macula
    container_name: arcade-peer2
    hostname: arcade-peer2
    environment:
      # Macula v0.8.5 - All nodes have all capabilities
      MACULA_QUIC_PORT: "4433"
      MACULA_REALM: "macula.arcade"
      HEALTH_PORT: "8080"
      # Connect to bootstrap node
      MACULA_BOOTSTRAP_URL: "https://arcade-gateway:4433"

      # Phoenix config
      PORT: "4000"
      PHX_HOST: "arcade-peer2"
      SECRET_KEY_BASE: "YOy9XY2LSMbMdNNs8a3jRtJxExpsbBxpxYOy9XY2LSMbMdNNs8a3jRtJxExpsbBxp"

      # TLS auto-generated in v0.8.5
      MACULA_CERT_PATH: "/opt/macula/certs/cert.pem"
      MACULA_KEY_PATH: "/opt/macula/certs/key.pem"

      # Database (in-memory)
      DATABASE_PATH: ":memory:"

      # Logging
      LOG_LEVEL: "info"
    ports:
      - "4002:4000"
      - "4435:4433/udp"
      - "8082:8080"
    networks:
      arcade-mesh:
        ipv4_address: 172.25.0.12
    depends_on:
      arcade-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s

  # Bot node - headless bot client for scalability testing
  arcade-bot1:
    build:
      context: .
      dockerfile: Dockerfile
      additional_contexts:
        macula: ../macula
    container_name: arcade-bot1
    hostname: arcade-bot1
    environment:
      # Macula v0.8.5 - All nodes have all capabilities
      MACULA_QUIC_PORT: "4433"
      MACULA_REALM: "macula.arcade"
      HEALTH_PORT: "8080"
      # Connect to bootstrap node
      MACULA_BOOTSTRAP_URL: "https://arcade-gateway:4433"

      # Phoenix config (headless, but still needs minimal config)
      PORT: "4000"
      PHX_HOST: "arcade-bot1"
      SECRET_KEY_BASE: "ZPz0YZ3MTNcNeOOt9b4kStKyFyqtcCyqyZPz0YZ3MTNcNeOOt9b4kStKyFyqtcCyqy"

      # TLS auto-generated in v0.8.5
      MACULA_CERT_PATH: "/opt/macula/certs/cert.pem"
      MACULA_KEY_PATH: "/opt/macula/certs/key.pem"

      # Database (in-memory)
      DATABASE_PATH: ":memory:"

      # Bot configuration - disabled for PvP demo
      BOT_COUNT: "0"

      # Logging
      LOG_LEVEL: "info"
    ports:
      - "4003:4000"
      - "4436:4433/udp"
      - "8083:8080"
    networks:
      arcade-mesh:
        ipv4_address: 172.25.0.13
    depends_on:
      arcade-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s

networks:
  arcade-mesh:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/24

volumes:
  gateway-certs:
